# HG changeset patch
# Parent c0a92c7f4a98aabcbccf9cd06a002f6c5d77959e
# User Mihai Sucan <mihai.sucan@gmail.com>
# Date 1336159807 -10800

diff -r c0a92c7f4a98 browser/devtools/webconsole/HUDService-content.js
--- a/browser/devtools/webconsole/HUDService-content.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/HUDService-content.js	Fri May 04 22:30:09 2012 +0300
@@ -45,31 +45,25 @@
 "use strict";
 
 // This code is appended to the browser content script.
-(function(_global) {
-const Cc = Components.classes;
-const Ci = Components.interfaces;
-const Cu = Components.utils;
+(function _HUDServiceContent() {
+let Cc = Components.classes;
+let Ci = Components.interfaces;
+let Cu = Components.utils;
 
-Cu.import("resource://gre/modules/XPCOMUtils.jsm");
-Cu.import("resource://gre/modules/Services.jsm");
+let tempScope = {};
+Cu.import("resource://gre/modules/XPCOMUtils.jsm", tempScope);
+Cu.import("resource://gre/modules/Services.jsm", tempScope);
+Cu.import("resource://gre/modules/ConsoleAPIStorage.jsm", tempScope);
+Cu.import("resource:///modules/WebConsoleUtils.jsm", tempScope);
 
-XPCOMUtils.defineLazyGetter(_global, "gConsoleStorage", function () {
-  let obj = {};
-  Cu.import("resource://gre/modules/ConsoleAPIStorage.jsm", obj);
-  return obj.ConsoleAPIStorage;
-});
+let XPCOMUtils = tempScope.XPCOMUtils;
+let Services = tempScope.Services;
+let gConsoleStorage = tempScope.ConsoleAPIStorage;
+let WebConsoleUtils = tempScope.WebConsoleUtils;
+let l10n = WebConsoleUtils.l10n;
+tempScope = null;
 
-XPCOMUtils.defineLazyGetter(_global, "WebConsoleUtils", function () {
-  let obj = {};
-  Cu.import("resource:///modules/WebConsoleUtils.jsm", obj);
-  return obj.WebConsoleUtils;
-});
-
-XPCOMUtils.defineLazyGetter(_global, "l10n", function () {
-  return WebConsoleUtils.l10n;
-});
-
-_global = null;
+let _alive = true; // Track if this content script should still be alive.
 
 /**
  * The Web Console content instance manager.
@@ -100,6 +94,26 @@
     this._messageListeners.forEach(function(aName) {
       addMessageListener(aName, this);
     }, this);
+
+    // Need to track the owner XUL window to listen to the unload and TabClose
+    // events, to avoid memory leaks.
+    let xulWindow = this.window.QueryInterface(Ci.nsIInterfaceRequestor)
+                    .getInterface(Ci.nsIWebNavigation)
+                    .QueryInterface(Ci.nsIDocShell)
+                    .chromeEventHandler.ownerDocument.defaultView;
+
+    xulWindow.addEventListener("unload", this._onXULWindowClose, false);
+
+    let tabContainer = xulWindow.gBrowser.tabContainer;
+    tabContainer.addEventListener("TabClose", this._onTabClose, false);
+
+    // Need to track private browsing change and quit application notifications,
+    // again to avoid memory leaks. The Web Console main process cannot notify
+    // this content script when the XUL window close, tab close, private
+    // browsing change and quit application events happen, so we must call
+    // Manager.destroy() on our own.
+    Services.obs.addObserver(this, "private-browsing-change-granted", false);
+    Services.obs.addObserver(this, "quit-application-granted", false);
   },
 
   /**
@@ -108,6 +122,10 @@
    */
   receiveMessage: function Manager_receiveMessage(aMessage)
   {
+    if (!_alive) {
+      return;
+    }
+
     if (!aMessage.json || (aMessage.name != "WebConsole:Init" &&
                            aMessage.json.hudId != this.hudId)) {
       Cu.reportError("Web Console content script: received message " +
@@ -137,6 +155,22 @@
   },
 
   /**
+   * Observe notifications from the nsIObserverService.
+   *
+   * @param mixed aSubject
+   * @param string aTopic
+   * @param mixed aData
+   */
+  observe: function Manager_observe(aSubject, aTopic, aData)
+  {
+    if (_alive && (aTopic == "quit-application-granted" ||
+        (aTopic == "private-browsing-change-granted" &&
+         (aData == "enter" || aData == "exit")))) {
+      this.destroy();
+    }
+  },
+
+  /**
    * The manager initialization code. This method is called when the Web Console
    * remote process initializes the content process (this code!).
    *
@@ -335,10 +369,50 @@
   },
 
   /**
+   * The XUL window "unload" event handler which destroys this content script
+   * instance.
+   * @private
+   */
+  _onXULWindowClose: function Manager__onXULWindowClose()
+  {
+    if (_alive) {
+      Manager.destroy();
+    }
+  },
+
+  /**
+   * The "TabClose" event handler which destroys this content script
+   * instance, if needed.
+   * @private
+   */
+  _onTabClose: function Manager__onTabClose(aEvent)
+  {
+    let tab = aEvent.target;
+    if (_alive && tab.linkedBrowser.contentWindow === Manager.window) {
+      Manager.destroy();
+    }
+  },
+
+  /**
    * Destroy the Web Console content script instance.
    */
   destroy: function Manager_destroy()
   {
+    Services.obs.removeObserver(this, "private-browsing-change-granted");
+    Services.obs.removeObserver(this, "quit-application-granted");
+
+    _alive = false;
+    let xulWindow = this.window.QueryInterface(Ci.nsIInterfaceRequestor)
+                    .getInterface(Ci.nsIWebNavigation)
+                    .QueryInterface(Ci.nsIDocShell)
+                    .chromeEventHandler.ownerDocument.defaultView;
+
+    xulWindow.removeEventListener("unload", this._onXULWindowClose, false);
+    let tabContainer = xulWindow.gBrowser.tabContainer;
+    tabContainer.removeEventListener("TabClose", this._onTabClose, false);
+
+    let hudId = this.hudId;
+
     this._messageListeners.forEach(function(aName) {
       removeMessageListener(aName, this);
     }, this);
@@ -347,7 +421,9 @@
 
     this.hudId = null;
     this._messageHandlers = null;
-    Manager = ConsoleAPIObserver = JSTerm = null;
+    Manager = ConsoleAPIObserver = JSTerm = ConsoleListener = null;
+    Cc = Ci = Cu = XPCOMUtils = Services = gConsoleStorage =
+      WebConsoleUtils = l10n = null;
   },
 };
 
@@ -499,7 +575,7 @@
    */
   observe: function CAO_observe(aMessage, aTopic)
   {
-    if (!aMessage || aTopic != "console-api-log-event") {
+    if (!_alive || !aMessage || aTopic != "console-api-log-event") {
       return;
     }
 
@@ -682,7 +758,7 @@
    */
   observe: function CL_observe(aScriptError)
   {
-    if (!(aScriptError instanceof Ci.nsIScriptError) ||
+    if (!_alive || !(aScriptError instanceof Ci.nsIScriptError) ||
         !aScriptError.outerWindowID) {
       return;
     }
@@ -749,4 +825,4 @@
 };
 
 Manager.init();
-})(this);
+})();
diff -r c0a92c7f4a98 browser/devtools/webconsole/HUDService.jsm
--- a/browser/devtools/webconsole/HUDService.jsm	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/HUDService.jsm	Fri May 04 22:30:09 2012 +0300
@@ -1503,8 +1503,9 @@
     let nBox = chromeDocument.defaultView.getNotificationBox(window);
     let hudId = "hud_" + nBox.id;
     let displayNode = chromeDocument.getElementById(hudId);
-
-    if (hudId in this.hudReferences && displayNode) {
+    let hudFound = (hudId in this.hudReferences) && displayNode;
+
+    if (hudFound) {
       if (!aAnimated) {
         this.storeHeight(hudId);
       }
@@ -1533,8 +1534,10 @@
       }
     }
 
-    let id = WebConsoleUtils.supportsString(hudId);
-    Services.obs.notifyObservers(id, "web-console-destroyed", null);
+    if (hudFound) {
+      let id = WebConsoleUtils.supportsString(hudId);
+      Services.obs.notifyObservers(id, "web-console-destroyed", null);
+    }
   },
 
   /**
@@ -4804,6 +4807,7 @@
   }
   this.hudId = node.getAttribute("id");
 
+  this.history = [];
   this.historyIndex = 0;
   this.historyPlaceHolder = 0;  // this.history.length;
   this.log = LogFactory("*** JSTerm:");
@@ -5425,7 +5429,7 @@
            node.selectionStart == 0 && !multiline;
   },
 
-  history: [],
+  history: null,
 
   // Stores the data for the last completion.
   lastCompletion: null,
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_cached_messages.js
--- a/browser/devtools/webconsole/test/browser_cached_messages.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_cached_messages.js	Fri May 04 22:30:09 2012 +0300
@@ -56,7 +56,7 @@
   // test to see if the messages are
   // displayed when the console UI is opened
 
-  openConsole(function(hud) {
+  openConsole(null, function(hud) {
     testLogEntry(hud.outputNode, "log Bazzle",
                  "Find a console log entry from before console UI is opened",
                  false, null);
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_580030_errors_after_page_reload.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_580030_errors_after_page_reload.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_580030_errors_after_page_reload.js	Fri May 04 22:30:09 2012 +0300
@@ -53,7 +53,7 @@
 function onLoad(aEvent) {
   browser.removeEventListener(aEvent.type, onLoad, true);
 
-  openConsole(function(hud) {
+  openConsole(null, function(hud) {
     hud.jsterm.clearOutput();
     browser.addEventListener("load", testErrorsAfterPageReload, true);
     content.location.reload();
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_582201_duplicate_errors.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_582201_duplicate_errors.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_582201_duplicate_errors.js	Fri May 04 22:30:09 2012 +0300
@@ -52,7 +52,7 @@
 function testDuplicateErrors() {
   browser.removeEventListener("DOMContentLoaded", testDuplicateErrors,
                               false);
-  openConsole(function(hud) {
+  openConsole(null, function(hud) {
     hud.jsterm.clearOutput();
 
     Services.console.registerListener(consoleObserver);
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_585237_line_limit.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_585237_line_limit.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_585237_line_limit.js	Fri May 04 22:30:09 2012 +0300
@@ -19,7 +19,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(function(aHud) {
+    openConsole(null, function(aHud) {
       hud = aHud;
       testDriver = testGen();
       testNext();
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_585956_console_trace.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_585956_console_trace.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_585956_console_trace.js	Fri May 04 22:30:09 2012 +0300
@@ -46,7 +46,7 @@
 function tabLoaded() {
   browser.removeEventListener("load", tabLoaded, true);
 
-  openConsole(function() {
+  openConsole(null, function() {
     browser.addEventListener("load", tabReloaded, true);
     content.location.reload();
   });
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_587617_output_copy.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_587617_output_copy.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_587617_output_copy.js	Fri May 04 22:30:09 2012 +0300
@@ -14,7 +14,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_588730_text_node_insertion.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_588730_text_node_insertion.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_588730_text_node_insertion.js	Fri May 04 22:30:09 2012 +0300
@@ -46,7 +46,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(testTextNodeInsertion);
+    openConsole(null, testTextNodeInsertion);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_593003_iframe_wrong_hud.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_593003_iframe_wrong_hud.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_593003_iframe_wrong_hud.js	Fri May 04 22:30:09 2012 +0300
@@ -50,45 +50,27 @@
   browser.addEventListener("load", tab1Loaded, true);
 }
 
-/**
- * Check if a log entry exists in the HUD output node.
- *
- * @param {Element} aOutputNode the HUD output node.
- * @param {string} aMatchString the string you want to check if it exists in the
- * output node.
- * @param {boolean} [aOnlyVisible=false] find only messages that are visible,
- * not hidden by the filter.
- * @param {boolean} [aFailIfFound=false] fail the test if the string is found in
- * the output node.
- */
-
 function tab1Loaded(aEvent) {
-  browser.removeEventListener(aEvent.type, arguments.callee, true);
-  browser.contentWindow.wrappedJSObject.console.log("FOO");
-  try {
-    openConsole();
-  }
-  catch (ex) {
-    log(ex);
-    log(ex.stack);
-  }
-
-  tab2 = gBrowser.addTab(TEST_DUMMY_URI);
-  gBrowser.selectedTab = tab2;
-  gBrowser.selectedBrowser.addEventListener("load", tab2Loaded, true);
+  browser.removeEventListener(aEvent.type, tab1Loaded, true);
+  content.console.log("FOO");
+  openConsole(null, function() {
+    tab2 = gBrowser.addTab(TEST_DUMMY_URI);
+    gBrowser.selectedTab = tab2;
+    gBrowser.selectedBrowser.addEventListener("load", tab2Loaded, true);
+  });
 }
 
 function tab2Loaded(aEvent) {
-  tab2.linkedBrowser.removeEventListener(aEvent.type, arguments.callee, true);
+  tab2.linkedBrowser.removeEventListener(aEvent.type, tab2Loaded, true);
 
-  HUDService.activateHUDForContext(gBrowser.selectedTab);
-
-  tab1.linkedBrowser.addEventListener("load", tab1Reloaded, true);
-  tab1.linkedBrowser.contentWindow.location.reload();
+  openConsole(gBrowser.selectedTab, function() {
+    tab1.linkedBrowser.addEventListener("load", tab1Reloaded, true);
+    tab1.linkedBrowser.contentWindow.location.reload();
+  });
 }
 
 function tab1Reloaded(aEvent) {
-  tab1.linkedBrowser.removeEventListener(aEvent.type, arguments.callee, true);
+  tab1.linkedBrowser.removeEventListener(aEvent.type, tab1Reloaded, true);
 
   let hud1 = HUDService.getHudByWindow(tab1.linkedBrowser.contentWindow);
   let outputNode1 = hud1.outputNode;
@@ -105,8 +87,9 @@
   msg = "Didn't find the iframe network request in tab2";
   testLogEntry(outputNode2, TEST_IFRAME_URI, msg, true, true);
 
-  HUDService.deactivateHUDForContext(tab2);
-  gBrowser.removeTab(tab2);
-
-  finishTest();
+  closeConsole(tab2, function() {
+    gBrowser.removeTab(tab2);
+    tab1 = tab2 = null;
+    executeSoon(finishTest);
+  });
 }
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_595350_multiple_windows_and_tabs.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_595350_multiple_windows_and_tabs.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_595350_multiple_windows_and_tabs.js	Fri May 04 22:30:09 2012 +0300
@@ -28,7 +28,7 @@
 }
 
 function onWindowLoad(aEvent) {
-  win2.removeEventListener(aEvent.type, arguments.callee, true);
+  win2.removeEventListener(aEvent.type, onWindowLoad, true);
 
   // Add two tabs in the new window.
   addTabs(win2);
@@ -39,48 +39,71 @@
     let tab = aWindow.gBrowser.addTab(TEST_URI);
     openTabs.push(tab);
 
-    tab.linkedBrowser.addEventListener("load", function(aEvent) {
-      tab.linkedBrowser.removeEventListener(aEvent.type, arguments.callee,
-        true);
+    tab.linkedBrowser.addEventListener("load", function onLoad(aEvent) {
+      tab.linkedBrowser.removeEventListener(aEvent.type, onLoad, true);
 
       loadedTabCount++;
       if (loadedTabCount >= 4) {
-        executeSoon(performTest);
+        executeSoon(openConsoles);
       }
     }, true);
   }
 }
 
-function performTest() {
+function openConsoles() {
   // open the Web Console for each of the four tabs and log a message.
+  let consolesOpen = 0;
   for (let i = 0; i < openTabs.length; i++) {
     let tab = openTabs[i];
-    HUDService.activateHUDForContext(tab);
-    let hudId = HUDService.getHudIdByWindow(tab.linkedBrowser.contentWindow);
-    ok(hudId, "HUD is open for tab " + i);
-    let HUD = HUDService.hudReferences[hudId];
-    HUD.console.log("message for tab " + i);
+    openConsole(tab, function(index, hud) {
+      ok(hud, "HUD is open for tab " + index);
+      hud.console.log("message for tab " + index);
+      consolesOpen++;
+    }.bind(null, i));
   }
 
-  let displays = Object.keys(HUDService.hudReferences);
-  is(displays.length, 4, "four displays found");
+  waitForSuccess({
+    name: "4 web consoles opened",
+    validatorFn: function()
+    {
+      return consolesOpen == 4;
+    },
+    successFn: closeConsoles,
+    failureFn: closeConsoles,
+  });
+}
+
+function closeConsoles() {
+  let consolesClosed = 0;
+
+  function onWebConsoleClose(aSubject, aTopic) {
+    if (aTopic == "web-console-destroyed") {
+      consolesClosed++;
+    }
+  }
+
+  Services.obs.addObserver(onWebConsoleClose, "web-console-destroyed", false);
 
   win2.close();
 
-  executeSoon(function() {
-    win1.gBrowser.removeTab(openTabs[0]);
-    win1.gBrowser.removeTab(openTabs[1]);
+  win1.gBrowser.removeTab(openTabs[0]);
+  win1.gBrowser.removeTab(openTabs[1]);
 
-    executeSoon(function() {
-      displays = Object.keys(HUDService.hudReferences);
-      is(displays.length, 0, "no displays found");
-      ok(!HUDService.storage, "no storage found");
-      ok(!HUDService.httpObserver, "no httpObserver found");
+  openTabs = win1 = win2 = null;
 
-      displays = openTabs = win1 = win2 = null;
+  function onTimeout() {
+    Services.obs.removeObserver(onWebConsoleClose, "web-console-destroyed");
+    executeSoon(finishTest);
+  }
 
-      finishTest();
-    });
+  waitForSuccess({
+    name: "4 web consoles closed",
+    validatorFn: function()
+    {
+      return consolesClosed == 4;
+    },
+    successFn: onTimeout,
+    failureFn: onTimeout,
   });
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_595934_message_categories.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_595934_message_categories.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_595934_message_categories.js	Fri May 04 22:30:09 2012 +0300
@@ -89,12 +89,12 @@
     category: "Image",
     matchString: "corrupt",
   },
-  /* Disabled until bug 675221 lands.
-  { // #7
+  { // #15
     file: "test-bug-595934-workers.html",
     category: "Web Worker",
     matchString: "fooBarWorker",
-  },*/
+    expectError: true,
+  },
 ];
 
 let pos = -1;
@@ -103,13 +103,14 @@
 let foundText = false;
 let output = null;
 let jsterm = null;
+let testEnded = false;
 
 let TestObserver = {
   QueryInterface: XPCOMUtils.generateQI([Ci.nsIObserver]),
 
   observe: function test_observe(aSubject)
   {
-    if (!(aSubject instanceof Ci.nsIScriptError)) {
+    if (testEnded || !(aSubject instanceof Ci.nsIScriptError)) {
       return;
     }
 
@@ -125,24 +126,21 @@
     else {
       ok(false, aSubject.sourceName + ':' + aSubject.lineNumber + '; ' +
                 aSubject.errorMessage);
-      executeSoon(finish);
+      testEnded = true;
+      executeSoon(finishTest);
     }
   }
 };
 
-function tabLoad(aEvent) {
-  browser.removeEventListener(aEvent.type, arguments.callee, true);
-
-  openConsole();
-
-  let hudId = HUDService.getHudIdByWindow(content);
-  let hud = HUDService.hudReferences[hudId];
+function consoleOpened(hud) {
   output = hud.outputNode;
   output.addEventListener("DOMNodeInserted", onDOMNodeInserted, false);
   jsterm = hud.jsterm;
 
   Services.console.registerListener(TestObserver);
 
+  registerCleanupFunction(testEnd);
+
   executeSoon(testNext);
 }
 
@@ -156,26 +154,30 @@
     let test = TESTS[pos];
     let testLocation = TESTS_PATH + test.file;
     if (test.onload) {
-      browser.addEventListener("load", function(aEvent) {
+      browser.addEventListener("load", function onLoad(aEvent) {
         if (content.location.href == testLocation) {
-          browser.removeEventListener(aEvent.type, arguments.callee, true);
+          browser.removeEventListener(aEvent.type, onLoad, true);
           test.onload(aEvent);
         }
       }, true);
     }
 
+    if (test.expectError) {
+      expectUncaughtException();
+    }
+
     content.location = testLocation;
   }
   else {
-    executeSoon(finish);
+    testEnded = true;
+    executeSoon(finishTest);
   }
 }
 
 function testEnd() {
   Services.console.unregisterListener(TestObserver);
   output.removeEventListener("DOMNodeInserted", onDOMNodeInserted, false);
-  output = jsterm = null;
-  finishTest();
+  TestObserver = output = jsterm = null;
 }
 
 function onDOMNodeInserted(aEvent) {
@@ -191,9 +193,10 @@
 }
 
 function test() {
-  registerCleanupFunction(testEnd);
-
   addTab("data:text/html;charset=utf-8,Web Console test for bug 595934 - message categories coverage.");
-  browser.addEventListener("load", tabLoad, true);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, consoleOpened);
+  }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_597756_reopen_closed_tab.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_597756_reopen_closed_tab.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_597756_reopen_closed_tab.js	Fri May 04 22:30:09 2012 +0300
@@ -13,17 +13,17 @@
 let newTabIsOpen = false;
 
 function tabLoaded(aEvent) {
-  gBrowser.selectedBrowser.removeEventListener(aEvent.type, arguments.callee, true);
+  gBrowser.selectedBrowser.removeEventListener(aEvent.type, tabLoaded, true);
 
-  HUDService.activateHUDForContext(gBrowser.selectedTab);
-
-  gBrowser.selectedBrowser.addEventListener("load", tabReloaded, true);
-  expectUncaughtException();
-  content.location.reload();
+  openConsole(gBrowser.selectedTab, function() {
+    gBrowser.selectedBrowser.addEventListener("load", tabReloaded, true);
+    expectUncaughtException();
+    content.location.reload();
+  });
 }
 
 function tabReloaded(aEvent) {
-  gBrowser.selectedBrowser.removeEventListener(aEvent.type, arguments.callee, true);
+  gBrowser.selectedBrowser.removeEventListener(aEvent.type, tabReloaded, true);
 
   let hudId = HUDService.getHudIdByWindow(content);
   let HUD = HUDService.hudReferences[hudId];
@@ -34,26 +34,24 @@
 
   executeSoon(function() {
     if (newTabIsOpen) {
-      testEnd();
+      executeSoon(finishTest);
       return;
     }
 
-    let newTab = gBrowser.addTab();
-    gBrowser.removeCurrentTab();
-    gBrowser.selectedTab = newTab;
+    closeConsole(gBrowser.selectedTab, function() {
+      gBrowser.removeCurrentTab();
 
-    newTabIsOpen = true;
-    gBrowser.selectedBrowser.addEventListener("load", tabLoaded, true);
-    expectUncaughtException();
-    content.location = TEST_URI;
+      let newTab = gBrowser.addTab();
+      gBrowser.selectedTab = newTab;
+
+      newTabIsOpen = true;
+      gBrowser.selectedBrowser.addEventListener("load", tabLoaded, true);
+      expectUncaughtException();
+      content.location = TEST_URI;
+    });
   });
 }
 
-function testEnd() {
-  gBrowser.removeCurrentTab();
-  executeSoon(finishTest);
-}
-
 function test() {
   expectUncaughtException();
   addTab(TEST_URI);
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_598357_jsterm_output.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_598357_jsterm_output.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_598357_jsterm_output.js	Fri May 04 22:30:09 2012 +0300
@@ -98,7 +98,7 @@
   browser.removeEventListener(aEvent.type, tabLoad, true);
 
   waitForFocus(function () {
-    openConsole(function(aHud) {
+    openConsole(null, function(aHud) {
       HUD = aHud;
       testNext();
     });
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_601352_scroll.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_601352_scroll.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_601352_scroll.js	Fri May 04 22:30:09 2012 +0300
@@ -66,7 +66,7 @@
   addTab("data:text/html;charset=utf-8,Web Console test for bug 601352");
   browser.addEventListener("load", function tabLoad(aEvent) {
     browser.removeEventListener(aEvent.type, tabLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_602572_log_bodies_checkbox.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_602572_log_bodies_checkbox.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_602572_log_bodies_checkbox.js	Fri May 04 22:30:09 2012 +0300
@@ -16,21 +16,20 @@
   addTab("data:text/html;charset=utf-8,Web Console test for bug 602572: log bodies checkbox. tab 1");
   tabs.push(tab);
 
-  browser.addEventListener("load", function(aEvent) {
-    browser.removeEventListener(aEvent.type, arguments.callee, true);
+  browser.addEventListener("load", function onLoad1(aEvent) {
+    browser.removeEventListener(aEvent.type, onLoad1, true);
 
-    openConsole();
+    openConsole(null, function() {
+      // open tab 2
+      addTab("data:text/html;charset=utf-8,Web Console test for bug 602572: log bodies checkbox. tab 2");
+      tabs.push(tab);
 
-    // open tab 2
-    addTab("data:text/html;charset=utf-8,Web Console test for bug 602572: log bodies checkbox. tab 2");
-    tabs.push(tab);
+      browser.addEventListener("load", function onLoad2(aEvent) {
+        browser.removeEventListener(aEvent.type, onLoad2, true);
 
-    browser.addEventListener("load", function(aEvent) {
-      browser.removeEventListener(aEvent.type, arguments.callee, true);
-
-      openConsole();
-      executeSoon(startTest);
-    }, true);
+        openConsole(null, startTest);
+      }, true);
+    });
   }, true);
 }
 
@@ -52,7 +51,7 @@
 
 function onpopupshown2(aEvent)
 {
-  menupopups[1].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[1].removeEventListener(aEvent.type, onpopupshown2, false);
 
   // By default bodies are not logged.
   isnot(menuitems[1].getAttribute("checked"), "true",
@@ -63,8 +62,8 @@
   // Enable body logging.
   HUDService.saveRequestAndResponseBodies = true;
 
-  menupopups[1].addEventListener("popuphidden", function(aEvent) {
-    menupopups[1].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[1].addEventListener("popuphidden", function _onhidden(aEvent) {
+    menupopups[1].removeEventListener(aEvent.type, _onhidden, false);
 
     // Reopen the context menu.
     menupopups[1].addEventListener("popupshown", onpopupshown2b, false);
@@ -75,11 +74,11 @@
 
 function onpopupshown2b(aEvent)
 {
-  menupopups[1].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[1].removeEventListener(aEvent.type, onpopupshown2b, false);
   is(menuitems[1].getAttribute("checked"), "true", "menuitems[1] is checked");
 
-  menupopups[1].addEventListener("popuphidden", function(aEvent) {
-    menupopups[1].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[1].addEventListener("popuphidden", function _onhidden(aEvent) {
+    menupopups[1].removeEventListener(aEvent.type, _onhidden, false);
 
     // Switch to tab 1 and open the Web Console context menu from there.
     gBrowser.selectedTab = tabs[0];
@@ -102,7 +101,7 @@
 
 function onpopupshown1(aEvent)
 {
-  menupopups[0].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[0].removeEventListener(aEvent.type, onpopupshown1, false);
 
   // The menuitem checkbox must be in sync with the other tabs.
   is(menuitems[0].getAttribute("checked"), "true", "menuitems[0] is checked");
@@ -111,8 +110,8 @@
   HUDService.saveRequestAndResponseBodies = false;
 
   // Close the menu, and switch back to tab 2.
-  menupopups[0].addEventListener("popuphidden", function(aEvent) {
-    menupopups[0].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[0].addEventListener("popuphidden", function _onhidden(aEvent) {
+    menupopups[0].removeEventListener(aEvent.type, _onhidden, false);
 
     gBrowser.selectedTab = tabs[1];
     waitForFocus(function() {
@@ -126,19 +125,20 @@
 
 function onpopupshown2c(aEvent)
 {
-  menupopups[1].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[1].removeEventListener(aEvent.type, onpopupshown2c, false);
 
   isnot(menuitems[1].getAttribute("checked"), "true",
         "menuitems[1] is not checked");
 
-  menupopups[1].addEventListener("popuphidden", function(aEvent) {
-    menupopups[1].removeEventListener(aEvent.type, arguments.callee, false);
+  menupopups[1].addEventListener("popuphidden", function _onhidden(aEvent) {
+    menupopups[1].removeEventListener(aEvent.type, _onhidden, false);
 
     // Done!
     huds = menuitems = menupopups = tabs = null;
-    HUDService.deactivateHUDForContext(gBrowser.selectedTab);
-    gBrowser.removeCurrentTab();
-    executeSoon(finishTest);
+    closeConsole(gBrowser.selectedTab, function() {
+      gBrowser.removeCurrentTab();
+      executeSoon(finishTest);
+    });
   }, false);
   menupopups[1].hidePopup();
 }
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_611795.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_611795.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_611795.js	Fri May 04 22:30:09 2012 +0300
@@ -67,7 +67,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(function(aHud) {
+    openConsole(null, function(aHud) {
       // Clear cached messages that are shown once the Web Console opens.
       aHud.jsterm.clearOutput(true);
       browser.addEventListener("load", onContentLoaded, true);
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_613642_maintain_scroll.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_613642_maintain_scroll.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_613642_maintain_scroll.js	Fri May 04 22:30:09 2012 +0300
@@ -95,7 +95,7 @@
   addTab("data:text/html;charset=utf-8,Web Console test for bug 613642: remember scroll location");
   browser.addEventListener("load", function tabLoad(aEvent) {
     browser.removeEventListener(aEvent.type, tabLoad, true);
-    openConsole(function(aHud) {
+    openConsole(null, function(aHud) {
       hud = aHud;
       testDriver = testGen();
       testDriver.next();
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_613642_prune_scroll.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_613642_prune_scroll.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_613642_prune_scroll.js	Fri May 04 22:30:09 2012 +0300
@@ -92,7 +92,7 @@
   browser.addEventListener("load", function tabLoad(aEvent) {
     browser.removeEventListener(aEvent.type, tabLoad, true);
 
-    openConsole(function(aHud) {
+    openConsole(null, function(aHud) {
       hud = aHud;
       testDriver = testGen();
       testDriver.next();
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_614793_jsterm_scroll.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_614793_jsterm_scroll.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_614793_jsterm_scroll.js	Fri May 04 22:30:09 2012 +0300
@@ -47,7 +47,7 @@
   addTab("data:text/html;charset=utf-8,Web Console test for bug 614793: jsterm result scroll");
   browser.addEventListener("load", function onLoad(aEvent) {
     browser.removeEventListener(aEvent.type, onLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_618078_network_exceptions.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_618078_network_exceptions.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_618078_network_exceptions.js	Fri May 04 22:30:09 2012 +0300
@@ -53,39 +53,31 @@
 
     is(aSubject.category, "content javascript", "error category");
 
+    testEnded = true;
     if (aSubject.category == "content javascript") {
       executeSoon(checkOutput);
     }
     else {
-      finish();
+      executeSoon(finishTest);
     }
   }
 };
 
 function checkOutput()
 {
-  if (testEnded) {
-    return;
-  }
-
   waitForSuccess({
     name: "exception message",
     validatorFn: function()
     {
       return hud.outputNode.textContent.indexOf("bug618078exception") > -1;
     },
-    successFn: finish,
-    failureFn: finish,
+    successFn: finishTest,
+    failureFn: finishTest,
   });
 }
 
 function testEnd()
 {
-  if (testEnded) {
-    return;
-  }
-
-  testEnded = true;
   Services.console.unregisterListener(TestObserver);
 }
 
@@ -96,17 +88,15 @@
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
 
-    openConsole();
+    openConsole(null, function(aHud) {
+      hud = aHud;
+      Services.console.registerListener(TestObserver);
+      registerCleanupFunction(testEnd);
 
-    let hudId = HUDService.getHudIdByWindow(content);
-    hud = HUDService.hudReferences[hudId];
-
-    Services.console.registerListener(TestObserver);
-    registerCleanupFunction(testEnd);
-
-    executeSoon(function() {
-      expectUncaughtException();
-      content.location = TEST_URI;
+      executeSoon(function() {
+        expectUncaughtException();
+        content.location = TEST_URI;
+      });
     });
   }, true);
 }
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_618311_private_browsing.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_618311_private_browsing.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_618311_private_browsing.js	Fri May 04 22:30:09 2012 +0300
@@ -44,8 +44,8 @@
 function test() {
   addTab("data:text/html;charset=utf-8,Web Console test for bug 618311 (private browsing)");
 
-  browser.addEventListener("load", function() {
-    browser.removeEventListener("load", arguments.callee, true);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
 
     registerCleanupFunction(function() {
       pb.privateBrowsingEnabled = false;
@@ -57,9 +57,10 @@
     togglePBAndThen(function() {
       ok(pb.privateBrowsingEnabled, "private browsing is enabled");
 
-      HUDService.activateHUDForContext(gBrowser.selectedTab);
-      content.location = TEST_URI;
-      gBrowser.selectedBrowser.addEventListener("load", tabLoaded, true);
+      openConsole(gBrowser.selectedTab, function() {
+        content.location = TEST_URI;
+        gBrowser.selectedBrowser.addEventListener("load", tabLoaded, true);
+      });
     });
   }, true);
 }
@@ -128,6 +129,7 @@
 
         ok(!pb.privateBrowsingEnabled, "private browsing is not enabled");
 
+        gBrowser.removeCurrentTab();
         executeSoon(finishTest);
       });
     }
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_621644_jsterm_dollar.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_621644_jsterm_dollar.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_621644_jsterm_dollar.js	Fri May 04 22:30:09 2012 +0300
@@ -10,14 +10,9 @@
 const TEST_URI = "http://example.com/browser/browser/devtools/webconsole/test/test-bug-621644-jsterm-dollar.html";
 
 function tabLoad(aEvent) {
-  browser.removeEventListener(aEvent.type, arguments.callee, true);
+  browser.removeEventListener(aEvent.type, tabLoad, true);
 
-  waitForFocus(function () {
-    openConsole();
-
-    let hudId = HUDService.getHudIdByWindow(content);
-    let HUD = HUDService.hudReferences[hudId];
-
+  openConsole(null, function(HUD) {
     HUD.jsterm.clearOutput();
 
     HUD.jsterm.setInputValue("$(document.body)");
@@ -39,7 +34,7 @@
        "jsterm output is correct for $$()");
 
     executeSoon(finishTest);
-  }, content);
+  });
 }
 
 function test() {
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_626484_output_copy_order.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_626484_output_copy_order.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_626484_output_copy_order.js	Fri May 04 22:30:09 2012 +0300
@@ -1,12 +1,12 @@
 /* Any copyright is dedicated to the Public Domain.
    http://creativecommons.org/publicdomain/zero/1.0/ */
-let itemsSet, HUD;
+let itemsSet, HUD, outputNode;
 
 function test() {
   addTab("data:text/html;charset=utf-8,Web Console test for bug 626484");
   browser.addEventListener("load", function tabLoaded(aEvent) {
     browser.removeEventListener(aEvent.type, tabLoaded, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
@@ -30,7 +30,7 @@
       return outputNode.querySelectorAll(".hud-log").length == 3;
     },
     successFn: nextTest,
-    failureFn: finish,
+    failureFn: finishTest,
   });
 }
 
@@ -38,8 +38,8 @@
   if (itemsSet.length === 0) {
     outputNode.clearSelection();
     HUD.jsterm.clearOutput();
-    HUD = null;
-    finish();
+    HUD = outputNode = null;
+    executeSoon(finishTest);
   }
   else {
     outputNode.clearSelection();
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_644419_log_limits.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_644419_log_limits.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_644419_log_limits.js	Fri May 04 22:30:09 2012 +0300
@@ -21,7 +21,7 @@
 function onLoad(aEvent) {
   browser.removeEventListener(aEvent.type, onLoad, true);
 
-  openConsole(function(aHud) {
+  openConsole(null, function(aHud) {
     aHud.jsterm.clearOutput();
     hud = aHud;
     outputNode = aHud.outputNode;
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_653531_highlighter_console_helper.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_653531_highlighter_console_helper.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_653531_highlighter_console_helper.js	Fri May 04 22:30:09 2012 +0300
@@ -97,7 +97,7 @@
   });
 }
 
-function performTestComparisons(evt)
+function performTestComparisons()
 {
   InspectorUI.highlighter.removeListener("nodeselected", performTestComparisons);
 
@@ -105,9 +105,11 @@
   is(InspectorUI.highlighter.node, h1, "node selected");
   is(InspectorUI.selection, h1, "selection matches node");
 
-  HUDService.activateHUDForContext(gBrowser.selectedTab);
-  let hudId = HUDService.getHudIdByWindow(content);
-  let hud = HUDService.hudReferences[hudId];
+  openConsole(gBrowser.selectedTab, performWebConsoleTests);
+}
+
+function performWebConsoleTests(hud)
+{
   let jsterm = hud.jsterm;
   outputNode = hud.outputNode;
 
@@ -127,8 +129,7 @@
 
 function finishUp() {
   InspectorUI.closeInspectorUI();
-  gBrowser.removeCurrentTab();
-  finish();
+  finishTest();
 }
 
 function test()
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_658368_time_methods.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_658368_time_methods.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_658368_time_methods.js	Fri May 04 22:30:09 2012 +0300
@@ -9,15 +9,13 @@
 function test() {
   addTab("http://example.com/browser/browser/devtools/webconsole/" +
          "test/test-bug-658368-time-methods.html");
-  openConsole();
-  browser.addEventListener("load", onLoad, true);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, consoleOpened);
+  }, true);
 }
 
-function onLoad(aEvent) {
-  browser.removeEventListener(aEvent.type, onLoad, true);
-
-  let hudId = HUDService.getHudIdByWindow(content);
-  let hud = HUDService.hudReferences[hudId];
+function consoleOpened(hud) {
   outputNode = hud.outputNode;
 
   executeSoon(function() {
@@ -28,16 +26,14 @@
     // tabs, do not contain the same value.
     addTab("data:text/html;charset=utf-8,<script type='text/javascript'>" +
            "console.timeEnd('bTimer');</script>");
-    openConsole();
-    browser.addEventListener("load", testTimerIndependenceInTabs, true);
+    browser.addEventListener("load", function onLoad() {
+      browser.removeEventListener("load", onLoad, true);
+      openConsole(null, testTimerIndependenceInTabs);
+    }, true);
   });
 }
 
-function testTimerIndependenceInTabs(aEvent) {
-  browser.removeEventListener(aEvent.type, testTimerIndependenceInTabs, true);
-
-  let hudId = HUDService.getHudIdByWindow(content);
-  let hud = HUDService.hudReferences[hudId];
+function testTimerIndependenceInTabs(hud) {
   outputNode = hud.outputNode;
 
   executeSoon(function() {
@@ -46,15 +42,16 @@
 
     // The next test makes sure that timers with the same name but in separate
     // pages, do not contain the same value.
-    browser.addEventListener("load", testTimerIndependenceInSameTab, true);
+    browser.addEventListener("load", function onLoad() {
+      browser.removeEventListener("load", onLoad, true);
+      executeSoon(testTimerIndependenceInSameTab);
+    }, true);
     content.location = "data:text/html;charset=utf-8,<script type='text/javascript'>" +
            "console.time('bTimer');</script>";
   });
 }
 
-function testTimerIndependenceInSameTab(aEvent) {
-  browser.removeEventListener(aEvent.type, testTimerIndependenceInSameTab, true);
-
+function testTimerIndependenceInSameTab() {
   let hudId = HUDService.getHudIdByWindow(content);
   let hud = HUDService.hudReferences[hudId];
   outputNode = hud.outputNode;
@@ -65,15 +62,16 @@
 
     // Now the following console.timeEnd() call shouldn't display anything,
     // if the timers in different pages are not related.
-    browser.addEventListener("load", testTimerIndependenceInSameTabAgain, true);
+    browser.addEventListener("load", function onLoad() {
+      browser.removeEventListener("load", onLoad, true);
+      executeSoon(testTimerIndependenceInSameTabAgain);
+    }, true);
     content.location = "data:text/html;charset=utf-8,<script type='text/javascript'>" +
            "console.timeEnd('bTimer');</script>";
   });
 }
 
-function testTimerIndependenceInSameTabAgain(aEvent) {
-  browser.removeEventListener(aEvent.type, testTimerIndependenceInSameTabAgain, true);
-
+function testTimerIndependenceInSameTabAgain(hud) {
   let hudId = HUDService.getHudIdByWindow(content);
   let hud = HUDService.hudReferences[hudId];
   outputNode = hud.outputNode;
@@ -82,6 +80,9 @@
     testLogEntry(outputNode, "bTimer: timer started", "bTimer was not started",
                  false, true);
 
-    finishTest();
+    closeConsole(gBrowser.selectedTab, function() {
+      gBrowser.removeCurrentTab();
+      executeSoon(finishTest);
+    });
   });
 }
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_659907_console_dir.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_659907_console_dir.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_659907_console_dir.js	Fri May 04 22:30:09 2012 +0300
@@ -11,7 +11,7 @@
          "object with a dir method");
   browser.addEventListener("load", function onLoad(aEvent) {
     browser.removeEventListener(aEvent.type, onLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_bug_664131_console_group.js
--- a/browser/devtools/webconsole/test/browser_webconsole_bug_664131_console_group.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_664131_console_group.js	Fri May 04 22:30:09 2012 +0300
@@ -14,7 +14,7 @@
          "object with group methods");
   browser.addEventListener("load", function onLoad(aEvent) {
     browser.removeEventListener(aEvent.type, onLoad, true);
-    openConsole(function(aHud) {
+    openConsole(null, function(aHud) {
       hud = aHud;
       testDriver = testGen();
       testNext();
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_chrome.js
--- a/browser/devtools/webconsole/test/browser_webconsole_chrome.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_chrome.js	Fri May 04 22:30:09 2012 +0300
@@ -42,15 +42,14 @@
 
 function test() {
   addTab(getBrowserURL());
-  browser.addEventListener("DOMContentLoaded", testChrome, false);
+  browser.addEventListener("DOMContentLoaded", function onLoad() {
+    browser.removeEventListener("DOMContentLoaded", onLoad, true);
+    openConsole();
+    testChrome(HUDService.getHudByWindow(content));
+  }, true);
 }
 
-function testChrome() {
-  browser.removeEventListener("DOMContentLoaded", testChrome, false);
-
-  openConsole();
-
-  let hud = HUDService.getHudByWindow(content);
+function testChrome(hud) {
   ok(hud, "we have a console");
   
   ok(hud.HUDBox, "we have the console display");
@@ -67,6 +66,7 @@
   jsterm.complete(jsterm.COMPLETE_HINT_ONLY);
   is(jsterm.completeNode.value, "    ment", "'docu' completion");
 
-  finish();
+  gBrowser.removeCurrentTab();
+  executeSoon(finishTest);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_console_extras.js
--- a/browser/devtools/webconsole/test/browser_webconsole_console_extras.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_console_extras.js	Fri May 04 22:30:09 2012 +0300
@@ -43,7 +43,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_console_logging_api.js
--- a/browser/devtools/webconsole/test/browser_webconsole_console_logging_api.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_console_logging_api.js	Fri May 04 22:30:09 2012 +0300
@@ -54,7 +54,7 @@
 function onLoad() {
   browser.removeEventListener("DOMContentLoaded", onLoad, false);
 
-  openConsole(function(aHud) {
+  openConsole(null, function(aHud) {
     hud = aHud;
     hudId = hud.hudId;
     outputNode = hud.outputNode;
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_copying_multiple_messages_inserts_newlines_in_between.js
--- a/browser/devtools/webconsole/test/browser_webconsole_copying_multiple_messages_inserts_newlines_in_between.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_copying_multiple_messages_inserts_newlines_in_between.js	Fri May 04 22:30:09 2012 +0300
@@ -20,7 +20,7 @@
 
 function onLoad() {
   browser.removeEventListener("DOMContentLoaded", onLoad, false);
-  openConsole(testNewlines);
+  openConsole(null, testNewlines);
 }
 
 function testNewlines(aHud) {
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_execution_scope.js
--- a/browser/devtools/webconsole/test/browser_webconsole_execution_scope.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_execution_scope.js	Fri May 04 22:30:09 2012 +0300
@@ -44,16 +44,14 @@
 
 function test() {
   addTab(TEST_URI);
-  browser.addEventListener("DOMContentLoaded", testExecutionScope, false);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, testExecutionScope);
+  }, true);
 }
 
-function testExecutionScope() {
-  browser.removeEventListener("DOMContentLoaded", testExecutionScope,
-                              false);
-
-  openConsole();
-
-  let jsterm = HUDService.getHudByWindow(content).jsterm;
+function testExecutionScope(hud) {
+  let jsterm = hud.jsterm;
 
   jsterm.clearOutput();
   jsterm.execute("location;");
@@ -67,9 +65,6 @@
   ok(nodes[0].textContent.indexOf(TEST_URI),
     "command was executed in the window scope");
 
-  jsterm.clearOutput();
-  jsterm.history.splice(0, jsterm.history.length);   // workaround for bug 592552
-
-  finishTest();
+  executeSoon(finishTest);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_history.js
--- a/browser/devtools/webconsole/test/browser_webconsole_history.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_history.js	Fri May 04 22:30:09 2012 +0300
@@ -48,15 +48,14 @@
 
 function test() {
   addTab(TEST_URI);
-  browser.addEventListener("DOMContentLoaded", testHistory, false);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, testHistory);
+  }, true);
 }
 
-function testHistory() {
-  browser.removeEventListener("DOMContentLoaded", testHistory, false);
-
-  openConsole();
-
-  let jsterm = HUDService.getHudByWindow(content).jsterm;
+function testHistory(hud) {
+  let jsterm = hud.jsterm;
   let input = jsterm.inputNode;
 
   let executeList = ["document", "window", "window.location"];
@@ -77,7 +76,6 @@
   jsterm.historyPeruse(HISTORY_BACK);
   is (input.value, executeList[0], "test that item is still still index 0");
 
-
   for (var i = 1; i < executeList.length; i++) {
     jsterm.historyPeruse(HISTORY_FORWARD);
     is (input.value, executeList[i], "check history next idx:" + i);
@@ -98,9 +96,6 @@
   jsterm.historyPeruse(HISTORY_BACK);
   is (input.value, executeList[idxLast], "check history next idx:" + idxLast);
 
-  jsterm.clearOutput();
-  jsterm.history.splice(0, jsterm.history.length);   // workaround for bug 592552
-
-  finishTest();
+  executeSoon(finishTest);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_jsterm.js
--- a/browser/devtools/webconsole/test/browser_webconsole_jsterm.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_jsterm.js	Fri May 04 22:30:09 2012 +0300
@@ -45,7 +45,10 @@
 
 function test() {
   addTab(TEST_URI);
-  browser.addEventListener("DOMContentLoaded", testJSTerm, false);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, testJSTerm);
+  }, true);
 }
 
 function checkResult(msg, desc, lines) {
@@ -55,13 +58,9 @@
     desc);
 }
 
-function testJSTerm()
+function testJSTerm(hud)
 {
-  browser.removeEventListener("DOMContentLoaded", testJSTerm, false);
-
-  openConsole();
-
-  jsterm = HUDService.getHudByWindow(content).jsterm;
+  jsterm = hud.jsterm;
 
   jsterm.clearOutput();
   jsterm.execute("'id=' + $('header').getAttribute('id')");
@@ -155,5 +154,5 @@
   checkResult("null", "null is null", 1);
 
   jsterm = null;
-  finishTest();
+  executeSoon(finishTest);
 }
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_live_filtering_of_message_types.js
--- a/browser/devtools/webconsole/test/browser_webconsole_live_filtering_of_message_types.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_live_filtering_of_message_types.js	Fri May 04 22:30:09 2012 +0300
@@ -46,7 +46,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_live_filtering_on_search_strings.js
--- a/browser/devtools/webconsole/test/browser_webconsole_live_filtering_on_search_strings.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_live_filtering_on_search_strings.js	Fri May 04 22:30:09 2012 +0300
@@ -48,7 +48,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_log_node_classes.js
--- a/browser/devtools/webconsole/test/browser_webconsole_log_node_classes.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_log_node_classes.js	Fri May 04 22:30:09 2012 +0300
@@ -47,7 +47,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(consoleOpened);
+    openConsole(null, consoleOpened);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_message_node_id.js
--- a/browser/devtools/webconsole/test/browser_webconsole_message_node_id.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_message_node_id.js	Fri May 04 22:30:09 2012 +0300
@@ -44,7 +44,7 @@
 
 function onLoad() {
   browser.removeEventListener("DOMContentLoaded", onLoad, false);
-  openConsole(function(hud) {
+  openConsole(null, function(hud) {
     content.console.log("a log message");
 
     waitForSuccess({
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_network_panel.js
--- a/browser/devtools/webconsole/test/browser_webconsole_network_panel.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_network_panel.js	Fri May 04 22:30:09 2012 +0300
@@ -49,14 +49,13 @@
 
 function test() {
   addTab(TEST_URI);
-  browser.addEventListener("DOMContentLoaded", testNetworkPanel, false);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, testNetworkPanel);
+  }, true);
 }
 
 function testNetworkPanel() {
-  browser.removeEventListener("DOMContentLoaded", testNetworkPanel,
-                              false);
-  openConsole();
-
   testDriver = testGen();
   testDriver.next();
 }
@@ -100,11 +99,10 @@
 function testGen() {
   let filterBox = HUDService.getHudByWindow(content).filterBox;
 
-  XPCOMUtils.defineLazyGetter(this, "l10n", function () {
-    let obj = {};
-    Cu.import("resource:///modules/WebConsoleUtils.jsm", obj);
-    return obj.WebConsoleUtils.l10n;
-  });
+  let tempScope  = {};
+  Cu.import("resource:///modules/WebConsoleUtils.jsm", tempScope);
+  let l10n = tempScope.WebConsoleUtils.l10n;
+  tempScope = null;
 
   var httpActivity = {
     url: "http://www.testpage.com",
@@ -489,5 +487,6 @@
   networkPanel.panel.hidePopup(); */
 
   // All done!
-  finish();
+  testDriver = null;
+  executeSoon(finishTest);
 }
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_null_and_undefined_output.js
--- a/browser/devtools/webconsole/test/browser_webconsole_null_and_undefined_output.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_null_and_undefined_output.js	Fri May 04 22:30:09 2012 +0300
@@ -45,17 +45,14 @@
 
 function test() {
   addTab(TEST_URI);
-  browser.addEventListener("DOMContentLoaded", testNullAndUndefinedOutput,
-                           false);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, testNullAndUndefinedOutput);
+  }, true);
 }
 
-function testNullAndUndefinedOutput() {
-  browser.removeEventListener("DOMContentLoaded",
-                              testNullAndUndefinedOutput, false);
-
-  openConsole();
-
-  let jsterm = HUDService.getHudByWindow(content).jsterm;
+function testNullAndUndefinedOutput(hud) {
+  let jsterm = hud.jsterm;
   let outputNode = jsterm.outputNode;
 
   jsterm.clearOutput();
@@ -72,9 +69,6 @@
   is(nodes.length, 2, "2 nodes in output");
   ok(nodes[1].textContent.indexOf("undefined") > -1, "'undefined' printed to output");
 
-  jsterm.clearOutput();
-  jsterm.history.splice(0, jsterm.history.length);   // workaround for bug 592552
-
-  finishTest();
+  executeSoon(finishTest);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_output_order.js
--- a/browser/devtools/webconsole/test/browser_webconsole_output_order.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_output_order.js	Fri May 04 22:30:09 2012 +0300
@@ -47,7 +47,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(testOutputOrder);
+    openConsole(null, testOutputOrder);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_view_source.js
--- a/browser/devtools/webconsole/test/browser_webconsole_view_source.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_view_source.js	Fri May 04 22:30:09 2012 +0300
@@ -10,7 +10,7 @@
   addTab(TEST_URI);
   browser.addEventListener("load", function onLoad() {
     browser.removeEventListener("load", onLoad, true);
-    openConsole(testViewSource);
+    openConsole(null, testViewSource);
   }, true);
 }
 
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/browser_webconsole_window_zombie.js
--- a/browser/devtools/webconsole/test/browser_webconsole_window_zombie.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/browser_webconsole_window_zombie.js	Fri May 04 22:30:09 2012 +0300
@@ -8,7 +8,10 @@
 
 function test() {
   addTab(TEST_URI);
-  browser.addEventListener("DOMContentLoaded", onLoad, false);
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+    openConsole(null, consoleOpened);
+  }, true);
   registerCleanupFunction(testEnd);
 }
 
@@ -16,13 +19,7 @@
   Services.prefs.clearUserPref(POSITION_PREF);
 }
 
-function onLoad() {
-  browser.removeEventListener("DOMContentLoaded", onLoad, false);
-
-  openConsole();
-
-  let hudId = HUDService.getHudIdByWindow(content);
-  let hudRef = HUDService.hudReferences[hudId];
+function consoleOpened(hudRef) {
   let hudBox = hudRef.HUDBox;
 
   // listen for the panel popupshown event.
@@ -33,7 +30,7 @@
 
     document.addEventListener("popuphidden", function popupHidden() {
       document.removeEventListener("popuphidden", popupHidden, false);
-      finishTest();
+      executeSoon(finishTest);
     }, false);
 
     // Close the window console via the menu item
diff -r c0a92c7f4a98 browser/devtools/webconsole/test/head.js
--- a/browser/devtools/webconsole/test/head.js	Thu Apr 26 23:06:34 2012 +0300
+++ b/browser/devtools/webconsole/test/head.js	Fri May 04 22:30:09 2012 +0300
@@ -156,13 +156,16 @@
 }
 
 /**
- * Open the Web Console for the current tab.
+ * Open the Web Console for the given tab.
  *
+ * @param nsIDOMElement [aTab]
+ *        Optional tab element for which you want open the Web Console. The
+ *        default tab is taken from the global variable |tab|.
  * @param function [aCallback]
  *        Optional function to invoke after the Web Console completes
- *        initialization.
+ *        initialization (web-console-created).
  */
-function openConsole(aCallback)
+function openConsole(aTab, aCallback)
 {
   function onWebConsoleOpen(aSubject, aTopic)
   {
@@ -178,35 +181,51 @@
     Services.obs.addObserver(onWebConsoleOpen, "web-console-created", false);
   }
 
-  HUDService.activateHUDForContext(tab);
+  HUDService.activateHUDForContext(aTab || tab);
 }
 
-function closeConsole()
+/**
+ * Close the Web Console for the given tab.
+ *
+ * @param nsIDOMElement [aTab]
+ *        Optional tab element for which you want close the Web Console. The
+ *        default tab is taken from the global variable |tab|.
+ * @param function [aCallback]
+ *        Optional function to invoke after the Web Console completes
+ *        closing (web-console-destroyed).
+ */
+function closeConsole(aTab, aCallback)
 {
-  HUDService.deactivateHUDForContext(tab);
+  function onWebConsoleClose(aSubject, aTopic)
+  {
+    if (aTopic == "web-console-destroyed") {
+      Services.obs.removeObserver(onWebConsoleClose, "web-console-destroyed");
+      aSubject.QueryInterface(Ci.nsISupportsString);
+      let hudId = aSubject.data;
+      executeSoon(aCallback.bind(null, hudId));
+    }
+  }
+
+  if (aCallback) {
+    Services.obs.addObserver(onWebConsoleClose, "web-console-destroyed", false);
+  }
+
+  HUDService.deactivateHUDForContext(aTab || tab);
 }
 
 function finishTest()
 {
   browser = hudId = hud = filterBox = outputNode = cs = null;
 
-  function onWebConsoleClose(aSubject, aTopic)
-  {
-    if (aTopic == "web-console-destroyed") {
-      Services.obs.removeObserver(onWebConsoleClose, "web-console-destroyed");
-      executeSoon(finish);
-    }
-  }
-
-  Services.obs.addObserver(onWebConsoleClose, "web-console-destroyed", false);
-
   let hud = HUDService.getHudByWindow(content);
   if (!hud) {
     finish();
     return;
   }
   hud.jsterm.clearOutput(true);
-  HUDService.deactivateHUDForContext(hud.tab);
+
+  closeConsole(hud.tab, finish);
+
   hud = null;
 }
 
